{% extends 'base.html' %}

{% block title %}Create Booking - Car Wash System{% endblock %}

{% block navigation %}{% endblock %}

{% block content %}
<div style="min-height: 100vh; background: #f9fafb; padding: 3rem 2rem;">
<div style="max-width: 800px; margin: 0 auto;">

<!-- Back Button -->
<a href="{% url 'user_services' %}" style="display: inline-flex; align-items: center; gap: 0.5rem; color: #6b7280; text-decoration: none; margin-bottom: 2rem; font-size: 0.875rem;">
    <i class="fas fa-arrow-left"></i> Back to Services
</a>

<!-- Page Header -->
<div style="text-align: center; margin-bottom: 3rem;">
    <h1 style="font-size: 2rem; font-weight: 700; color: #111827; margin-bottom: 0.5rem;">Book Your Car Wash</h1>
    <p style="color: #6b7280;">Complete the steps below to schedule your appointment</p>
</div>

<!-- Progress Indicator -->
<div style="display: flex; justify-content: space-between; margin-bottom: 3rem; position: relative;">
    <div style="position: absolute; top: 20px; left: 0; right: 0; height: 2px; background: #e5e7eb; z-index: 0;"></div>
    <div id="progressBar" style="position: absolute; top: 20px; left: 0; height: 2px; background: #111827; z-index: 0; width: 0%; transition: width 0.3s;"></div>
    
    <div class="step-indicator" data-step="1" style="text-align: center; position: relative; z-index: 1;">
        <div class="step-circle active" style="width: 40px; height: 40px; border-radius: 50%; background: #111827; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-weight: 700;">1</div>
        <p style="font-size: 0.75rem; color: #111827; font-weight: 500;">Personal</p>
    </div>
    <div class="step-indicator" data-step="2" style="text-align: center; position: relative; z-index: 1;">
        <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-weight: 700;">2</div>
        <p style="font-size: 0.75rem; color: #6b7280;">Vehicle</p>
    </div>
    <div class="step-indicator" data-step="3" style="text-align: center; position: relative; z-index: 1;">
        <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-weight: 700;">3</div>
        <p style="font-size: 0.75rem; color: #6b7280;">Service</p>
    </div>
    <div class="step-indicator" data-step="4" style="text-align: center; position: relative; z-index: 1;">
        <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-weight: 700;">4</div>
        <p style="font-size: 0.75rem; color: #6b7280;">Date & Time</p>
    </div>
</div>

<!-- Form Container -->
<form method="post" id="bookingForm" style="background: #ffffff; border-radius: 12px; padding: 3rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb;">
    {% csrf_token %}
    
    <!-- Step 1: Personal Information -->
    <div class="form-step" id="step1" style="display: block;">
        <div style="margin-bottom: 2rem;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin-bottom: 0.5rem;">Personal Information</h2>
            <p style="color: #6b7280; font-size: 0.875rem;">Please provide your contact details</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
                <label for="id_customer_name" style="display: block; margin-bottom: 0.5rem; color: #111827; font-weight: 500; font-size: 0.875rem;">Full Name *</label>
                {{ form.customer_name }}
                {% if form.customer_name.errors %}
                    <p style="color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.customer_name.errors.0 }}</p>
                {% endif %}
            </div>
            
            <div>
                <label for="id_customer_email" style="display: block; margin-bottom: 0.5rem; color: #111827; font-weight: 500; font-size: 0.875rem;">Email Address *</label>
                {{ form.customer_email }}
                {% if form.customer_email.errors %}
                    <p style="color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.customer_email.errors.0 }}</p>
                {% endif %}
            </div>
        </div>
        
        <div style="margin-bottom: 2rem;">
            <label for="id_customer_phone" style="display: block; margin-bottom: 0.5rem; color: #111827; font-weight: 500; font-size: 0.875rem;">Phone Number *</label>
            {{ form.customer_phone }}
            {% if form.customer_phone.errors %}
                <p style="color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.customer_phone.errors.0 }}</p>
            {% endif %}
        </div>
        
        <button type="button" onclick="validateAndNext(1, 2)" class="btn btn-primary" style="width: 100%; padding: 1rem; font-weight: 600;">
            Continue <i class="fas fa-arrow-right"></i>
        </button>
    </div>
    
    <!-- Step 2: Vehicle Details -->
    <div class="form-step" id="step2" style="display: none;">
        <div style="margin-bottom: 2rem;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin-bottom: 0.5rem;">Vehicle Details</h2>
            <p style="color: #6b7280; font-size: 0.875rem;">Tell us about your vehicle</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
            <div>
                <label for="id_vehicle_type" style="display: block; margin-bottom: 0.5rem; color: #111827; font-weight: 500; font-size: 0.875rem;">Vehicle Type *</label>
                {{ form.vehicle_type }}
                {% if form.vehicle_type.errors %}
                    <p style="color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.vehicle_type.errors.0 }}</p>
                {% endif %}
            </div>
            
            <div>
                <label for="id_vehicle_plate" style="display: block; margin-bottom: 0.5rem; color: #111827; font-weight: 500; font-size: 0.875rem;">License Plate *</label>
                {{ form.vehicle_plate }}
                {% if form.vehicle_plate.errors %}
                    <p style="color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.vehicle_plate.errors.0 }}</p>
                {% endif %}
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="button" onclick="prevStep(1)" class="btn btn-secondary" style="flex: 1; padding: 1rem;">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <button type="button" onclick="validateAndNext(2, 3)" class="btn btn-primary" style="flex: 1; padding: 1rem; font-weight: 600;">
                Continue <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>
    
    <!-- Step 3: Service Selection -->
    <div class="form-step" id="step3" style="display: none;">
        <div style="margin-bottom: 2rem;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin-bottom: 0.5rem;">Select Service</h2>
            <p style="color: #6b7280; font-size: 0.875rem;">Choose the service you'd like</p>
        </div>
        
        {% if selected_service %}
        <!-- Show Selected Service -->
        <div style="border: 2px solid #111827; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; background: #f9fafb;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <div style="width: 50px; height: 50px; background: #111827; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas {{ selected_service.icon }}" style="font-size: 1.25rem; color: white;"></i>
                </div>
                <div>
                    <h3 style="font-size: 1.25rem; font-weight: 600; color: #111827; margin: 0;">{{ selected_service.name }}</h3>
                    <p style="color: #6b7280; margin: 0;">{{ selected_service.description }}</p>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                <span style="font-size: 1.5rem; font-weight: 700; color: #111827;">â‚±{{ selected_service.price }}</span>
                <span style="color: #6b7280;">{{ selected_service.get_duration_display }}</span>
            </div>
        </div>
        <input type="hidden" name="service" value="basic">
        <input type="hidden" name="service_id" value="{{ selected_service.id }}">
        {% else %}
        <!-- Service Dropdown if no service selected -->
        <div style="margin-bottom: 2rem;">
            <label for="id_service" style="display: block; margin-bottom: 0.5rem; color: #111827; font-weight: 500; font-size: 0.875rem;">Choose a service *</label>
            {{ form.service }}
            {% if form.service.errors %}
                <p style="color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.service.errors.0 }}</p>
            {% endif %}
        </div>
        {% endif %}
        
        <div style="display: flex; gap: 1rem;">
            <button type="button" onclick="prevStep(2)" class="btn btn-secondary" style="flex: 1; padding: 1rem;">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <button type="button" onclick="validateAndNext(3, 4)" class="btn btn-primary" style="flex: 1; padding: 1rem; font-weight: 600;">
                Continue <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>
    
    <!-- Step 4: Date & Time -->
    <div class="form-step" id="step4" style="display: none;">
        <div style="margin-bottom: 2rem;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin-bottom: 0.5rem;">Choose Date & Time</h2>
            <p style="color: #6b7280; font-size: 0.875rem;">Select your appointment date and time slot</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
            <div>
                <label for="id_booking_date" style="display: block; margin-bottom: 0.5rem; color: #111827; font-weight: 500; font-size: 0.875rem;">Appointment Date *</label>
                {{ form.booking_date }}
                {% if form.booking_date.errors %}
                    <p style="color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.booking_date.errors.0 }}</p>
                {% endif %}
            </div>
            
            <div>
                <label for="id_booking_time" style="display: block; margin-bottom: 0.5rem; color: #111827; font-weight: 500; font-size: 0.875rem;">Time Slot *</label>
                {{ form.booking_time }}
                {% if form.booking_time.errors %}
                    <p style="color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.booking_time.errors.0 }}</p>
                {% endif %}
                <p style="color: #6b7280; font-size: 0.75rem; margin-top: 0.5rem;">Business hours: 8:00 AM - 5:00 PM</p>
                <p style="color: #f59e0b; font-size: 0.75rem; margin-top: 0.25rem;"><i class="fas fa-info-circle"></i> Each time slot has a maximum of 5 bookings</p>
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="button" onclick="prevStep(3)" class="btn btn-secondary" style="flex: 1; padding: 1rem;">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <button type="submit" class="btn btn-primary" style="flex: 2; padding: 1rem; font-weight: 600;">
                Complete Booking <i class="fas fa-check"></i>
            </button>
        </div>
    </div>
</form>

</div>
</div>

<script>
let currentStep = 1;

function nextStep(step) {
    // Hide current step
    document.getElementById('step' + currentStep).style.display = 'none';
    
    // Show next step
    document.getElementById('step' + step).style.display = 'block';
    
    // Update progress
    currentStep = step;
    updateProgress();
}

function prevStep(step) {
    // Hide current step
    document.getElementById('step' + currentStep).style.display = 'none';
    
    // Show previous step
    document.getElementById('step' + step).style.display = 'block';
    
    // Update progress
    currentStep = step;
    updateProgress();
}

function validateAndNext(currentStepNum, nextStepNum) {
    // Get all required inputs in the current step
    const currentStepElement = document.getElementById('step' + currentStepNum);
    const requiredInputs = currentStepElement.querySelectorAll('input[required], select[required], textarea[required]');
    
    let allFilled = true;
    let firstEmptyField = null;
    
    // Check each required field
    requiredInputs.forEach(input => {
        if (!input.value || input.value.trim() === '') {
            allFilled = false;
            if (!firstEmptyField) {
                firstEmptyField = input;
            }
            // Add error styling
            input.style.borderColor = '#ef4444';
        } else {
            // Remove error styling
            input.style.borderColor = '#e5e7eb';
        }
    });
    
    if (!allFilled) {
        alert('Please fill in all required fields before continuing.');
        if (firstEmptyField) {
            firstEmptyField.focus();
        }
        return;
    }
    
    // All fields are filled, proceed to next step
    nextStep(nextStepNum);
}

function updateProgress() {
    // Update progress bar
    const progress = ((currentStep - 1) / 3) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    
    // Update step indicators
    const indicators = document.querySelectorAll('.step-indicator');
    indicators.forEach((indicator, index) => {
        const stepNum = index + 1;
        const circle = indicator.querySelector('.step-circle');
        const text = indicator.querySelector('p');
        
        if (stepNum < currentStep) {
            // Completed step
            circle.style.background = '#111827';
            circle.style.color = 'white';
            text.style.color = '#111827';
        } else if (stepNum === currentStep) {
            // Active step
            circle.style.background = '#111827';
            circle.style.color = 'white';
            text.style.color = '#111827';
            text.style.fontWeight = '500';
        } else {
            // Upcoming step
            circle.style.background = '#e5e7eb';
            circle.style.color = '#9ca3af';
            text.style.color = '#6b7280';
            text.style.fontWeight = '400';
        }
    });
}

// On page load, check for errors and show the appropriate step
document.addEventListener('DOMContentLoaded', function() {
    // Check which step has errors
    const step1Errors = document.querySelector('#step1 .text-danger, #step1 p[style*="color: #ef4444"]');
    const step2Errors = document.querySelector('#step2 .text-danger, #step2 p[style*="color: #ef4444"]');
    const step3Errors = document.querySelector('#step3 .text-danger, #step3 p[style*="color: #ef4444"]');
    const step4Errors = document.querySelector('#step4 .text-danger, #step4 p[style*="color: #ef4444"]');
    
    if (step4Errors) {
        nextStep(4);
    } else if (step3Errors) {
        nextStep(3);
    } else if (step2Errors) {
        nextStep(2);
    }
    // Step 1 is already showing by default
});

// Prevent booking past dates
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('id_booking_date');
    if (dateInput) {
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute('min', today);
        
        // Show warning if user tries to select past date
        dateInput.addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);
            
            if (selectedDate < todayDate) {
                alert('Cannot book appointments in the past. Please select today or a future date.');
                this.value = '';
            }
        });
    }
});
</script>
{% endblock %}

{% block footer %}{% endblock %}
